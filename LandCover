// 1. åŠ è½½å¹¿å·è¡Œæ”¿è¾¹ç•Œ
var guangzhou = ee.FeatureCollection('users/marshhiiiiii/GZBoundary');

// 2. åŠ è½½ ESA WorldCover 2021 åˆ†ç±»æ•°æ®ï¼ˆç”¨ä½œè®­ç»ƒæ ‡ç­¾ï¼‰
var esa = ee.ImageCollection('ESA/WorldCover/v100')
             .first()
             .select('Map')
             .clip(guangzhou);

// 3. åŠ è½½ Landsat 9 SR æ•°æ®
var landsat9 = ee.ImageCollection('LANDSAT/LC09/C02/T1_L2')
  .filterBounds(guangzhou)
  .filterDate('2023-01-01', '2023-12-31')
  .filter(ee.Filter.lt('CLOUD_COVER', 10))
  .map(function(image) {
    var cloudMask = image.select('QA_PIXEL').bitwiseAnd(1 << 3).eq(0);
    return image.updateMask(cloudMask)
                .select(['SR_B2','SR_B3','SR_B4','SR_B5','SR_B6','SR_B7'])
                .divide(10000)
                .copyProperties(image, ['system:time_start']);
  });

// 4. åˆæˆå¹´åº¦å½±åƒ
var composite = landsat9.median().clip(guangzhou);

// 5. åˆ›å»ºè®­ç»ƒæ ·æœ¬ï¼ˆç”¨ ESA æ•°æ®çš„åƒå…ƒï¼‰
var trainingSamples = composite.addBands(esa).sample({
  region: guangzhou.geometry(),
  scale: 30,
  numPixels: 5000, // é‡‡æ ·æ•°é‡ï¼Œå¯æ ¹æ®éœ€è¦è°ƒå¤§
  seed: 42,
  geometries: true
});

// 6. è®­ç»ƒåˆ†ç±»å™¨
var classifier = ee.Classifier.smileRandomForest(50).train({
  features: trainingSamples,
  classProperty: 'Map',
  inputProperties: composite.bandNames()
});

// 7. æ‰§è¡Œåˆ†ç±»
var classified = composite.classify(classifier);

// 8. å¯è§†åŒ–
Map.centerObject(guangzhou, 9);
Map.addLayer(classified, {
  min: 10,
  max: 100,
  palette: [
    '006400', // æ ‘
    'ffbb22', // è‰åœ°
    'ffff4c', // è€•åœ°
    'f096ff', // æ¹¿åœ°
    'fa0000', // åŸå¸‚
    'b4b4b4', // è£¸åœ°
    'f0f0f0', // é›ªå†°
    '0032c8', // æ°´ä½“
    '0096a0', // æ²¿æµ·æ¹¿åœ°
    '00cf75', // æ²¼æ³½
    'fae6a0'  // å¯è€•ä½†æœªç§åœ°
  ]
}, 'Land Cover by Landsat9 + ESA');

// 9. å¯¼å‡ºç»“æœ
Export.image.toDrive({
  image: classified,
  description: 'Landsat9_GZ_ESA_LandCover',
  folder: 'GEEExports',
  fileNamePrefix: 'guangzhou_landcover_2023_rf',
  region: guangzhou.geometry(),
  scale: 30,
  crs: 'EPSG:4326',
  maxPixels: 1e13
});

// === åˆ›å»ºå›¾ä¾‹ç»„ä»¶ ===
var legend = ui.Panel({
  style: {
    position: 'bottom-right',
    padding: '8px 15px'
  }
});

legend.add(ui.Label({
  value: 'ğŸŒ ESA WorldCover å›¾ä¾‹',
  style: {fontWeight: 'bold', fontSize: '14px', margin: '0 0 6px 0'}
}));

// 10. å›¾ä¾‹æ¡ç›®åˆ—è¡¨ï¼šé¢œè‰² + æ ‡ç­¾
var legendItems = [
  {color: '#006400', label: '10 æ ‘æœ¨'},
  {color: '#ffbb22', label: '20 çŒæœ¨åœ°'},
  {color: '#ffff4c', label: '30 è‰åœ°'},
  {color: '#f096ff', label: '40 å†œç”°'},
  {color: '#fa0000', label: '50 åŸå¸‚å»ºæˆåŒº'},
  {color: '#b4b4b4', label: '60 è£¸åœ°'},
  {color: '#f0f0f0', label: '70 é›ª/å†°'},
  {color: '#0032c8', label: '80 æ°´ä½“'},
  {color: '#0096a0', label: '90 è‰æœ¬æ¹¿åœ°'},
  {color: '#00cf75', label: '95 çº¢æ ‘æ—'},
  {color: '#fae6a0', label: '100 è‹”è—“/åœ°è¡£'}
];

// æ·»åŠ æ¯ä¸ªå›¾ä¾‹æ¡ç›®
legendItems.forEach(function(item) {
  var colorBox = ui.Label('', {
    backgroundColor: item.color,
    padding: '8px',
    margin: '0 8px 4px 0'
  });
  var description = ui.Label(item.label, {margin: '0 0 4px 0'});
  
  var legendItem = ui.Panel({
    widgets: [colorBox, description],
    layout: ui.Panel.Layout.Flow('horizontal')
  });
  
  legend.add(legendItem);
});

// æ·»åŠ å›¾ä¾‹åˆ°åœ°å›¾ç•Œé¢
Map.add(legend);
